
《S1-MAIN-D板子问题list》：

0、《S1-MAIN-C板子问题list》
1、电源部分断电放电问题：两个大电容82uF放电，整机工作时12V的负载多大？12V加100Ω/1W放电电阻？
2、原理图修改：根据BOM的那7个插件座子（包括剩下那些命名不太规范的插件物料，如CC1101 module），规范修改每个座子的value值/具体型号
   原理图和BOM一起修改
3、连接线材添加：普通的6pin线材（连接麻将机主板和色盘控制板的），然后分出3pin给S1-MAIN-D主板（看原理图，采集按6键和洗牌结束信号）
4、连接线材BOM定义：线材型号、长度、颜色、是否加套管、连接端子的要求、时间交期（参考《定制X3电源线说明_朱泉水》和KOK单机版样机）
5、BOM修改：8M晶振改成3225封装（原理图和PCB）、《S1-MAIN-D-BOM修改list》

测试：
1、断电放电时间：全负载工作时测试掉电时间
2、瞬间电流大：测试稳定性（是否会影响单片机系统）、0.3mm线径的大线圈瞬间电流达4A、0.25线径只有2.5A（测试大线圈的功能和稳定性）
3、S1稳定性测试：通信稳定性和打色准确率（战神比KOK更稳定 = KOK打色时转盘停止了之后骰子还能翻转运动）
4、转盘马达卡住或转速不一致问题/时序逻辑：打色不准确、打色时转盘停止了之后骰子还能翻转运动 = 转盘马达闭环控制？怎么控制固定转速？
5、电源测试指标？：12V电压值偏高、测试主板是否有漏电、变压器测试（吱吱叫声和发热）、（温升、长时间老化稳定性、带载能力、纹波...）
6、433M通信干扰问题测试：CC1101之间互相通信是否影响主板和骰子的通信？改成315M或者868.35M（CMT2117A发射 + CMT2117A接收）
7、大线圈发热测试：连续20次打色测试、ADC测量大线圈温度
8、无线充电线圈发热测试：整机48h长时间工作，测量充电线圈的波形和幅值是否变化、发热是否正常（分别测量带不带散热片的具体温度值）
9、漏电测试：双12V电源测试是否漏电？S1主板采集色盘控制板两路信号的电路是否漏电？要换成光耦隔离输入采集？

结构问题（主板盒子设计开模）：整理DXF文件给结构工程师（长宽高+开孔） = 座子、插件元件、LED指示灯、侧边复位按键、螺丝孔等
                              参考战神单机版（V6飞机版）可以适配大多数机器的安装（底盘大线圈方案 + 色盘控制学习）

软件调试：
0、软件规格：安卓手机端apk更新规则/玩法（参考战神的apk = 先定义好所有的参数变量）、
1、采集洗牌结束信号和色盘控制板的6个按键信号（不同色盘的控制板不同？是否需要学习？参考战神V6飞机盒？）= 谁先拿牌 = 采集谁打骰子
2、复位功能（恢复出厂设置）/清除已学习存储的数据？硬件功能检测？ERROR指示？
3、CC1101模块收发：《LiteCtrl-master》、《LiteCtrl-master（X2）_覃先维》、《实验十三：定时器PWM输出（S1遥控板）》
4、和4个A83T主板通信：通信协议的定义（命令和数据）
5、移植起手好牌算法：《起手好牌算法_李光挺》
6、硬件检测（生产测试/售后维护）：怎么检测？无线充电ok？无线通信ok？大线圈控制ok？有问题怎么处理？
7、模拟联调：游戏端模拟洗牌打色联调（S1主板+UART+PC端游戏）-- 光挺

S1出货清单list：参考战神V6飞机盒和KOK单机版
安装方式：
使用方法：《KOK-六键遥控器功能说明》
测试方法：《KOK-六键遥控器功能说明》


A83T通信协议：0xff 0xaa 方位 cmd len data [校验码低8位] [校验码高8位]
《麻将牌值对应图》：万桶条东...白...（1 - 44）

软件调试：4串口通信、遥控收发（CC1101模块）、无线充电、线圈控制逻辑（打骰测试）、获取136张随机牌（7小对算法）、《S1主板软件流程图框架》、
          采集KEY信号和DS信号（开始洗牌和结束洗牌信号）、CC2540蓝牙模块、Flash模拟eeprom读写、等...
通信：A83T发识别结果给S1主板、S1主板请求重发、S1主板发全部识别结果给东方位、东方位请求重发、东方位20s内发送点数命令（否则S1主板请求）


包头			方位	CMD		长度	数据	结尾
0xff 0xaa		0-4		0-10	len		data	CRC16

方位0-4：东南西北S1
CMD 0-7：
0=该方位的牌的数量；				A83T-->S1
1=请求重发牌的数量；				S1-->A83T
2=发单个牌；						A83T-->S1
3=请求重新发单个牌；				S1-->A83T
4=整个方位的牌的数据；				S1-->A83T（东）
5=请求重发整个方位的牌的数据；		A83T（东）-->S1
6=点数；							A83T（东）-->S1
7=请求重发点数；					S1-->A83T（东）
8=洗牌结束信号；					S1-->A83T（东）
9=客户所在方位和庄家方位打色信号；	S1-->A83T（东）

点数：0xff 0xaa	0x00 0x06 len data CRC16（最多3个点数）

解析：洗牌开始信号和洗牌结束信号、6个按键
问题：A83T怎么知道谁打骰子？怎么计算点数？





//命令类型
enum CMD{
  CMD_CARD_NUMBER = 0,   // 牌数d
  CMD_CARD_NUMBER_REQUEST = 1, //牌数量请{
  CMD_CARD_SEND = 2,           // 牌单个数据的发送 
  CMD_CARD_SEND_REQUEST = 3,   //发牌请求
  CMD_CARD_DATA = 4,           //保存S1发过来的牌
  CMD_CARD_DATA_REQUEST = 5,  //向S1请求一个方位的牌
  CMD_DICE_RESULT = 6,         // 骰盘结果
  CMD_DICE_RESULT_REQUEST = 7, // 骰盘结果请求 暂时不用
  CMD_SHUFFLE_CARD_END                = 8, //洗牌结束；(洗牌结束开始出打骰结果  打骰成功清除牌的数据)
  CMD_PLAY_DICE                  = 9, // 传庄家方位 并返回会打骰结果 （如果第一次没有将打骰结果的给校敬的情况才会使用 如同 骰盘结果请求）
  CMD_CLEAR_PLAY_DICE             = 10,//清除打骰
  CMD_CAER_DATA_TO_S1            = 11,// 整个方位的发送给S1;
  CMD_OPEN_CAMERA             = 12, // 开灯
  CMD_CLOSE_CAMERA            =13,  // 关灯
};




实验器材:
	MiniSTM32F103开发板V3版本
	
实验目的:
	学习STM32内部FLASH模拟成EEPROM的使用方法.
	
硬件资源:
	1,DS0(连接在PA8) 
	2,串口1(波特率:9600,PA9/PA10连接在板载USB转串口芯片CH340上面)
	3,ALIENTEK 2.8/3.5/4.3/7寸TFTLCD模块(通过GPIO驱动,连接关系见lcd.h)
	4,按键KEY0(PC5)/KEY_UP(PA0,也称之为WK_UP)  
		
实验现象:
	本实验开机后,先显示一些提示信息，然后在主循环里面检测两个按键，其中1个按键（WK_UP）用来执行写
	入FLASH的操作，另外一个按键（KEY0）用来执行读出操作，在TFTLCD模块上显示相关信息。同时用DS0提
	示程序正在运行。
	另外,本实验可以借助USMART调试。不过切记写入地址不要把用户代码区给写了，否则可能死机。

注意事项:  
	1,4.3寸和7寸屏需要比较大电流,USB供电可能不足,请用外部电源供电(5V电源，接VOUT2即可).
	2,本例程在LCD_Init函数里面(在ILI93xx.c),用到了printf,如果不初始化串口1,将导致液晶无法显示!! 
	3,LCD模块在开发板的LCD接口上面，必须靠右插 
	4,不要把1820和PA0的跳线帽跳上,否则可能导致按键"不灵". 
	

					正点原子@ALIENTEK
					2014-3-12
					广州市星翼电子科技有限公司
					电话：020-38271790
					传真：020-36773971
					购买：http://shop62103354.taobao.com
					http://shop62057469.taobao.com
					公司网站：www.alientek.com
					技术论坛：www.openedv.com